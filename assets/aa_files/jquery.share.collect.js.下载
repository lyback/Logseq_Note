!function ($, factory) {
    var module = factory();
    module.init();
}(jQuery, function () {
    //  构造函数
    function subjectConstructor() {
        //  判断data是否为空，不为空的话将data中的数据挂载到this
        if (!$.isEmptyObject(this.data)) {
            for (var key in this.data) {
                this[key] = this.data[key];
            }
        }
        //  将methods中的方法挂载到this
        if (!$.isEmptyObject(this.methods)) {
            for (var key in this.methods) {
                this[key] = this.methods[key];
            }
        }
    }

    subjectConstructor.prototype = {
        data: {
            id: $("input[name='id']").val(),
            type: $("input[name='dataType']").val(),
            shareParams: JSON.parse($('input[name="shareBody"]').val())
        },
        init: function () {
            this.bindElement();
            this.setWxShare();
            this.qqShare();
            this.wbShare();
        },
        bindElement: function () {
            this.QQSHAREBTN = $('#QQshareBtn');
        	this.WBSGAREBTN = $('#WBshareBtn');
            this.COLLECTBTN = $('.collect-btn');
            this.PRAISEBTN = $('.good-btn');
            this.bindMethod();
        },
        bindMethod: function () {
            this.COLLECTBTN.off('click').on('click', $.proxy(this.collect, this));
            this.PRAISEBTN.off('click').on('click', $.proxy(this.praise, this));
        },
        methods: {
            //  初始化二维码弹窗
            setWxShare: function() {
                var $this = this;
                $('.wx-share_btn').setShare({
                    title: '打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮',
                    callback: function() {
                        $this.addUpNum();
                    }
                });
            },
            //  qq分享
            qqShare: function() {
                var $this = this;
                var p = {
                    url: window.location.href,
                    showcount: '1',
                    desc: "",
                    summary: $this.shareParams.desc,
                    title: $this.shareParams.title,
                    site: '',
                    pics: $this.shareParams.imgUrl ? $this.shareParams.imgUrl : $this.shareParams.thumb,
                    style: '203',
                    width: 98,
                    height: 22
                };
                var s = [];
                for(var i in p){
                    s.push(i + '=' + encodeURIComponent(p[i]||''));
                }
                var url = "//connect.qq.com/widget/shareqq/index.html?" + s.join('&');
                var qq_shareBtn = document.getElementById("QQshareBtn");
                var qq_shareBtn1 = document.getElementById("QQshareBtn1");
                if(qq_shareBtn) {
                    qq_shareBtn.setAttribute("href", url);
                    qq_shareBtn.onclick = function() {
                        $this.addUpNum();
                    }
                }
                if(qq_shareBtn1) {
                    qq_shareBtn1.setAttribute("href", url);
                    qq_shareBtn1.onclick = function() {
                        $this.addUpNum();
                    }
                }
            },
            //  微博分享
            wbShare: function() {
                var $this = this;
                var wb_shareBtn = document.getElementById("WBshareBtn"),
                wb_shareBtn1 = document.getElementById("WBshareBtn1"),
                wb_url = encodeURIComponent(window.location.href),
                wb_appkey = "",
                wb_title = $this.shareParams.title,
                wb_ralateUid = "",
                wb_pic = $this.shareParams.imgUrl ? $this.shareParams.imgUrl : $this.shareParams.thumb,
                wb_language = "zh_cn";
                if(wb_shareBtn) {
                    wb_shareBtn.setAttribute("href", "//service.weibo.com/share/share.php?url="+ wb_url + "&appkey=" + wb_appkey + "&title=" + wb_title + "&pic=" + wb_pic + "&ralateUid=" + wb_ralateUid + "&language=" + wb_language);
                    wb_shareBtn.onclick = function() {
                        $this.addUpNum();
                    }
                }
                if(wb_shareBtn1) {
                    wb_shareBtn1.setAttribute("href", "//service.weibo.com/share/share.php?url="+ wb_url + "&appkey=" + wb_appkey + "&title=" + wb_title + "&pic=" + wb_pic + "&ralateUid=" + wb_ralateUid + "&language=" + wb_language);
                    wb_shareBtn1.onclick = function() {
                        $this.addUpNum();
                    }
                }
            },
            //  统计的分享次数
            addUpNum: function() {
                var $this = this;
                $.ajax({
                    type: "post",
                    url: API + "c=My&a=myShare",
                    data:{
                        target_id: $('input[name="id"]').val(),
                        target: $('input[name="dataType"]').val()
                    },
                    success: function (data) {
                    },
                    error: function (arr) {
                        console.log(arr)
                    }
                });
            },
            //  收藏||取消收藏
            collect: function(ev) {
                var $this = this;
                var e = ev || window.event;
                var state = $(e.currentTarget).attr("data-state");
                $.ajax({
                    type: "post",
                    url: API + "c=My&a=myCollect",
                    data: {
                        target_id: $this.id,
                        target: $this.type
                    },
                    success: function (data) {
                        if (data.errcode == 0) {
                            $('.collect-btn').toggleClass('collect-btn_hover');
                            $(e.currentTarget).attr({
                                "data-state": state == 0 ? 1 : 0,
                                "title": state == 0 ? "取消收藏" : "收藏"
                            });
                        } else if(data.errcode == -100000) {
                            // var loginUrl = data.data.redirectUrl;
                            // window.open(loginUrl, "_self");
                            $("body").loginWrap({
                                type:"login"
                            })
                        } else {
                            prompt("500", "2000", false, data.errstr);
                        }
                    },
                    error: function (err) {
                        console.log(err)
                    }
                });
            },
            //  点赞||取消点赞
            praise: function(ev) {
                var $this = this;
                var e = ev || window.event;
                var state = $(e.currentTarget).attr("data-state");
                $.ajax({
                    type: "post",
                    url: API + "m=api&c=My&a=myLike",
                    data: {
                        target_id: $this.id,
                        target: $this.type
                    },
                    success: function (data) {
                        if (data.errcode == 0) {
                            $('.good-btn').toggleClass('good-btn_hover');
                            $(e.currentTarget).attr({
                                "data-state": state == 0 ? 1 : 0,
                                "title": state == 0 ? "取消点赞" : "点赞"
                            });
                        } else if (data.errcode == -100000) {
                            // var loginUrl = data.data.redirectUrl;
                            // window.open(loginUrl,"_self");
                            $("body").loginWrap({
                                type:"login"
                            })
                        } else {
                            prompt("500", "2000", false, data.errstr);
                        }
                    },
                    error: function (err) {
                        console.log(err)
                    }
                });
            }
        }
    };
    return new subjectConstructor();
});

