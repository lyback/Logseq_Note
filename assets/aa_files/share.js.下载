(function ($) {
    var shareConstruct = function (ele, opt) {
        this.$ele = ele;
        this.defaults = {
            title: '',
            url: window.location.href,
            qrcodeUrl: '',
            page: ''
        };
        this.options = $.extend({}, this.defaults, opt);
    };
    shareConstruct.prototype = {
        init: function () {
            this.bind();
        },
        //  微信分享弹窗(使用此功能需先引入jquery.qrcode.js)
        renderWeixinPopup: function (ev) {
            $('body').append(
                '<div class="szy-qrcode_wrapper ' + this.options.page + '-qrcode_wrapper">' +
                    '<div class="szy-qrcode_inner">' +
                        '<div class="clear"><img class="icon-close" src="' + SYXZ.CDN + '/static/images/ico/close-search.png" /></div>' +
                        '<p class="title ellipsis-one" title="' + this.options.title + '">' + this.options.title + '</p>' +
                        '<div id="qrcode"></div>' +
                    '</div>' +
                '</div>'
            );
            $('body').css({
                height: '100%',
                overflow: 'hidden'
            });
            var e = ev || window.event;
            var url = $(e.target).attr('data-url');
            var dataUrl = url ? url : this.options.url;
            this.QRCODEWRAPPER = $('.szy-qrcode_wrapper');
            this.QRCODEWRAPPER.fadeIn(200);
            this.QRCODE = $('#qrcode');
            this.CLOSEBTN = $('.icon-close');
            this.CLOSEBTN.off('click').on('click', $.proxy(this.closeWeixinPopup, this));
            this.getQrCode(dataUrl);
            if(this.options.callback && typeof this.options.callback == 'function') {
                this.options.callback();
            }
        },
        bind: function () {
            this.$ele.off('click').on('click', $.proxy(this.renderWeixinPopup, this));
        },
        //  生成二维码
        getQrCode: function (url) {
            if(this.options.qrcodeUrl) {
                this.QRCODE.html('<img src=' + this.options.qrcodeUrl + ' />');
            } else {
                this.QRCODE.qrcode({
                    render: "canvas", //也可以替换为table
                    width: 200,
                    height: 200,
                    text: url
                })
            }
        },
        //  关闭微信分享弹窗
        closeWeixinPopup: function () {
            var $this = this;
            $this.QRCODEWRAPPER.fadeOut(200, function () {
                $this.QRCODEWRAPPER.remove();
            });
            $('body').css({
                height: 'auto',
                overflow: 'visible'
            });
        }
    };
    $.fn.setShare = function (options) {
        var setShare = new shareConstruct(this, options);
        setShare.init();
        return this;
    };
})(jQuery);
