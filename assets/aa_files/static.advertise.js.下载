!function ($, factory) {
    var module = factory();
    module.init();
}(jQuery, function () {
    //  构造函数
    function Constructor() {
        //  判断data是否为空，不为空的话将data中的数据挂载到this
        if (!$.isEmptyObject(this.data)) {
            for (var key in this.data) {
                this[key] = this.data[key];
            }
        }
        //  将methods中的方法挂载到this
        if (!$.isEmptyObject(this.methods)) {
            for (var key in this.methods) {
                this[key] = this.methods[key];
            }
        }
    }

    Constructor.prototype = {
        data: {
            position: $('input[name="position"]').val(),
            data: {
                'home': {
                    module_type: 'xz_index'
                },
                'channel': {
                    module_type: 'xz_tags',
                    model_id: $('input[name="model_id"]').val(),
                    tag_id: $('input[name="tag_ids"]').val()
                },
                'article': {
                    module_type: 'xz_details_tags',
                    cd_id:$('input[name="cd_id"]').val()
                }
            }
        },
        init: function () {
            //文章详情页广告
            if(this.position==="article"){
                this.getDetailAdvert();
            }else{
                this.getStaticAdvert();
            }
        },
        methods: {
            getStaticAdvert: function() {
                var $this = this;
                $.ajax({
                    url: API + 'm=web&c=adv&a=getFixedList',
                    type: 'POST',
                    data: $this.data[$this.position]
                }).done(function(res) {
                    if(res.errcode === 0) {
                        var data = res.data.list;
                        var A1show = false;
                        if(data){
                            if(res.data.position.indexOf("A3")<0){
                                $('.article-bottom_advertise').remove();
                            }
                            for(var key in data) {
                                var html = template('staticAdvertTemp', data[key][0]);
                                if($('.advert[position="' + key + '"]').attr('special') !== 'special') {
                                    $('.advert[position="' + key + '"]').show().attr('click-url', data[key][0].click_url).append(html);
                                } else {
                                    $('.advert[position="' + key + '"]').attr('click-url', data[key][0].click_url).append(html);
                                }
                                if(key=='A1'){
                                    A1show = true;
                                }
                            }
                        }else{
                            $('.article-bottom_advertise').remove();
                        }
                        if(A1show){
                            $(".google-index-A1").hide();
                        }else{
                            $(".google-index-A1").show();
                        }
                    }
                })
            },
            getDetailAdvert: function(){
                var $this = this;
                $.ajax({
                    url: API + 'm=web&c=AdvArticle&a=getAdv',
                    type: 'POST',
                    data: {
                        article_id:$("input[name='article_id']").val(),
                        terminal:"pc"
                    }
                }).done(function(res) {
                    if(res.errcode === 0) {
                        //文中广告
                        if(res.data.adv.top){
                            res.data.adv.top.click_tk = res.data.adv.top.click_tk.join(",");
                            var advhtml = template('detailAdvertTemp', res.data.adv.top);
                            $(".img2text-adv_wrapper").html(advhtml);
                        }
                        if(res.data.adv.middle){
                            res.data.adv.middle.click_tk = res.data.adv.middle.click_tk.join(",");
                            var advmiddlehtml = template('detailAdvertTemp', res.data.adv.middle);
                            $(".article_content p:eq(4)").after(advmiddlehtml);
                        }
                        if(res.data.adv.top_text){
                            res.data.adv.top_text.click_tk = res.data.adv.top_text.click_tk.join(",");
                            var advhtml2 = template('detailAdvertTemp', res.data.adv.top_text);
                            $(".textadv_wrapper").html(advhtml2);
                        }
                        //固定位广告
                        var data = res.data.fix;
                        var A1show = false;
                        var A5show = false;
                        if(data){
                            if(res.data.position.indexOf("A3")<0){
                                $('.article-bottom_advertise').remove();
                            }
                            //文章详情页右侧添加A4默认图
                            if(res.data.position.indexOf("A4")<0){
                                var dataA4 = {
                                    'landing':'https://u.jd.com/NwwvBJn',
                                    'image_url':'https://img.shangyexinzhi.com/cdn/main/release/static/images/article/detail-right_advimg.png?456',
                                    'imp_tk':[],
                                    'click_tk':[]
                                }
                                var htmlA4 = template('staticAdvertTemp', dataA4);
                                $('.advert[position="A4"]').show().attr('click-url', dataA4.click_tk).append(htmlA4);
                            }
                            for(var key in data) {
                                var html = template('staticAdvertTemp', data[key]);
                                if($('.advert[position="' + key + '"]').attr('special') !== 'special') {
                                    $('.advert[position="' + key + '"]').show().attr('click-url', data[key].click_tk).append(html);
                                } else {
                                    $('.advert[position="' + key + '"]').attr('click-url', data[key].click_tk).append(html);
                                }
                                if(key=='A1'){
                                    A1show = true;
                                }
                                if(key=='A5'){
                                    A5show = true;
                                }
                            }
                        }else{
                            $('.article-bottom_advertise').remove();
                        }
                        if(A1show){
                            $(".google-index-A1").hide();
                        }else{
                            $(".google-index-A1").show();
                        }
                        if(A5show){
                            $(".baidu-detail_apc0").hide();
                        }else{
                            $(".baidu-detail_apc0").show();
                        }
                        //右侧百度位广告
                        if(res.data.pc_list1 && res.data.pc_list1.length>0){
                            for(var i=0;i<res.data.pc_list1.length;i++){
                                res.data.pc_list1[i].click_tk = res.data.pc_list1[i].click_tk.join(",");
                            }
                            var advdetailhtml1 = template('detailListAdvertTemp', {list:res.data.pc_list1});
                            $(".pc-list1_wrapper").html(advdetailhtml1).show();
                        }
                        if(res.data.pc_list2 && res.data.pc_list2.length>0){
                            for(var i=0;i<res.data.pc_list2.length;i++){
                                res.data.pc_list2[i].click_tk = res.data.pc_list2[i].click_tk.join(",");
                            }
                            var advdetailhtml2 = template('detailListAdvertTemp', {list:res.data.pc_list2});
                            $(".pc-list2_wrapper").html(advdetailhtml2).show();
                        }
                        if(res.data.pc_list3 && res.data.pc_list3.length>0){
                            for(var i=0;i<res.data.pc_list3.length;i++){
                                res.data.pc_list3[i].click_tk = res.data.pc_list3[i].click_tk.join(",");
                            }
                            var advdetailhtml3 = template('detailListAdvertTemp', {list:res.data.pc_list3});
                            $(".pc-list3_wrapper").html(advdetailhtml3).show();
                        }
                    }
                })
            }
        }
    }
    return new Constructor()
});

!function() {
    $('.advert[position]').on('click', function() {
        var url = $(this).attr('click-url');
        var urlArr = url.split(",");
        for(var i=0;i<urlArr.length;i++){
            (function(i){
                $.ajax({
                    url: urlArr[i],
                    type: 'POST'
                }).done(function(){});
            })(i)
        }
    });
    $(".page-wrapper_article").on('click','.advclick',function() {
        var href = $(this).attr('data-href');
        var clickurl = $(this).attr('data-clickurl');
        var clickurlArr = clickurl.split(",");
        for(var i=0;i<clickurlArr.length;i++){
            (function(i){
                $.ajax({
                    url: clickurlArr[i],
                    type: 'POST'
                }).done(function(){});
            })(i)
        }
        window.open(href,"_blank")
    });

}();
