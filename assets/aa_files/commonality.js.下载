var API_URL = window.location.protocol + '//' + window.location.host + '/' + SYXZ.API_DOMAIN;
var WWWURL = "/wwwapi";
!function ($, factory) {
    var module = factory();
    module.init();
}(jQuery, function () {
    //  构造函数
    function Constructor() {
        //  判断data是否为空，不为空的话将data中的数据挂载到this
        if (!$.isEmptyObject(this.data)) {
            for (var key in this.data) {
                this[key] = this.data[key];
            }
        }
        //  将methods中的方法挂载到this
        if (!$.isEmptyObject(this.methods)) {
            for (var key1 in this.methods) {
                this[key1] = this.methods[key1];
            }
        }
        //  为元素绑定事件
        if (!$.isEmptyObject(this.eventConfig())) {
            for (var key2 in this.eventConfig()) {
                if(!$.isEmptyObject(this.eventConfig()[key2])) {
                    for(var key3 in this.eventConfig()[key2]) {
                        var ev = this.eventConfig()[key2][key3];
                        $(key3).off(key2).on(key2, $.proxy(ev, this));
                    }
                }
            }
        }
    }

    Constructor.prototype = {
        data: {
            userId: $('input[name="userinfo"]').val() ? JSON.parse($('input[name="userinfo"]').val()).user_id : ''
        },
        eventConfig: function() {
            var $this = this;
            return {
                'click': {
                    '.out': this.exitLogin,
                    '.portrait-wrapper .head-wrapper': this.clearMsgNum,
                    '.tool-bar_wrapper li.message-tip a': this.clearMsgNum,
                }
            }
        },
        init: function() {
            if($('.header').length > 0) {
                if(this.userId) {
                    this.initChat();
                }
                this.setGlobalSearch();
            }
        },
        methods: {
            //  退出登录
            exitLogin: function() {
                $.ajax({
                    type: "post",
                    url: API_URL + "?c=login&a=loginOut&d=login",
                }).done(function(res) {
                    if(res.errcode == "0") {
                        location.reload()
                    }
                })
            },
            // 聊天设置
            initChat: function() {
                var _this = this;
                //点击消息消除红点
                $('header .message').click(function(){
                    localStorage.setItem("total_msg_count" + this.userId, 0)
                });

                //获取本地离线缓存
                var _total_unread_msg_count = 0;
                var _total_msg_count = !localStorage.getItem("total_msg_count" + this.userId) ? 0 : parseInt(localStorage.getItem("total_msg_count" + this.userId));

                //请求ajax接口获取用户SESSION
                var _session = $('input[name="session"]').val();
                var _userinfo = $('input[name="userinfo"]').val();
                //初始化im组件
                MIM.init({'host':SYXZ.SOCKET_HOST, 'port':9090});

                //im组件就绪
                MIM.ready(function(){
                    /******** 系统回调 *******/
                    //登录消息接收回调
                    MIM.loginNotificationCallBack({
                        success : function(data){
                            //渲染在线用户总数量
                             $('.user-count').text(parseInt($('.user-count').text()) + 1);
                        },
                        error : function(e){
                            console.log(e);
                        },
                    });

                    // 登出消息接收回调
                    MIM.logoutNotificationCallBack({
                        success : function(data){
                            console.log(data);
                        },
                        error : function(e){
                            console.log(e);
                        },
                    });
                     // 普通聊天消息接收回调
                    MIM.mpSendSingleMsgToUserCallBack({
                        success : function(data){
                            var _data = data.data;
                            _total_msg_count++;
                            localStorage.setItem("total_msg_count" + _this.userId, _total_msg_count);

                            //渲染页面红点数量
                            var _t = parseInt(_total_msg_count + _total_unread_msg_count);

                            if(_t > 0){
                                $(".header-right .portrait-wrapper .msg-num_wrapper").show().html(_t);
                                $(".tool-bar_wrapper li.message-tip .circle-tip").show().html(_t);
                                if(_t >= 10) {
                                    $(".header-right .portrait-wrapper .msg-num_wrapper").html('<img class="omit" src="' + SYXZ.CDN + '/static/images/index/omit.png">');
                                    $(".tool-bar_wrapper li.message-tip .circle-tip").html('<img class="omit" src="' + SYXZ.CDN + '/static/images/index/omit1.png">');
                                }
                            } else {
                                $(".header-right .portrait-wrapper .msg-num_wrapper").hide().html('');
                                $(".tool-bar_wrapper li.message-tip .circle-tip").hide().html('');
                            }
                        },
                        error : function(e){
                            console.log(e);
                        },
                    });

                    //用户登录
                    MIM.login({
                        session : _session,
                        success : function(data){
                            //这句必须的
                            MIM.session = data.session;

                            //渲染页面红点数量
                            _total_unread_msg_count = parseInt(data.session.unread.total);
                            var _t = parseInt(_total_msg_count + data.session.unread.total);
                            if(_t > 0){
                                $(".header-right .portrait-wrapper .msg-num_wrapper").show().html(_t);
                                $(".tool-bar_wrapper li.message-tip .circle-tip").show().html(_t);
                                if(_t >= 10) {
                                    $(".header-right .portrait-wrapper .msg-num_wrapper").html('<img class="omit" src="' + SYXZ.CDN + '/static/images/index/omit.png">');
                                    $(".tool-bar_wrapper li.message-tip .circle-tip").html('<img class="omit" src="' + SYXZ.CDN + '/static/images/index/omit1.png">');
                                }
                            } else {
                                $(".header-right .portrait-wrapper .msg-num_wrapper").hide().html('');
                                $(".tool-bar_wrapper li.message-tip .circle-tip").hide().html('');
                            }
                        },
                        error : function(e){
                            console.log(e);
                        },
                    });
                });
            },
            //  全局搜索
            setGlobalSearch: function() {
                if($('.header-search-logo').length > 0) {
                    $('.header-search-logo').globalSearch();
                }
            },
            // 清空消息数量本地缓存
            clearMsgNum: function() {
                localStorage.setItem("total_msg_count" + this.userId, 0);
                $(".header-right .portrait-wrapper .msg-num_wrapper").hide();
                $(".tool-bar_wrapper li.message-tip .circle-tip").hide();
            }
        }
    };
    return new Constructor();
});
